!function(e){var t={};function r(s){if(t[s])return t[s].exports;var a=t[s]={i:s,l:!1,exports:{}};return e[s].call(a.exports,a,a.exports,r),a.l=!0,a.exports}r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(s,a,function(t){return e[t]}.bind(null,a));return s},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/public",r(r.s=16)}([function(e,t){e.exports=require("express")},function(e,t){e.exports=class{static info(e){console.log(new Date+" - info::::: "+e)}static debug(e){console.log(new Date+" - debug::::: "+e)}static error(e){console.log(new Date+" - error::::: "+e)}}},function(e,t,r){const s=r(22),a=r(11),n=r(1);a.config();e.exports=class{static async encode(e){try{return await s.sign({data:e},process.env.SECRET,{expiresIn:""+process.env.TOKEN_VALIDATION})}catch(e){n.error(e)}}static decode(e){try{return s.verify(e,process.env.SECRET)}catch(t){n.error("error at jwt",t),n.error(e)}}static getToken(e){const t=e.header("Authorization");return t?t.replace("Bearer","").trim():null}}},function(e,t,r){const s=r(1);e.exports=class{constructor(e,t){if(!e||!t)throw new Error("Repository and Model are both required");this.repository=new e,this.table=t,this.logger=s}async get(e){return await this.repository.get(e)}async create(e){let t=await this.repository.create(e);if(!t.erro)return t.rows[0];{let e=t;if(e.constraint&&1!=e.routine.toLowerCase().indexOf("unique")){throw{erro:!0,message:"Violação de constraint única: "+e.constraint.substring(e.constraint.indexOf("_"))}}}}async update(e){let t=await this.repository.update(e);if(t.erro)throw new Error(t);return t.rows[0]}async delete(e){return await this.repository.delete(e)}async list(){let e=await this.repository.list();return e=e.map(e=>new this.table(e)),e}async search(e){let t=await this.repository.search(e);return t=t.map(e=>new this.table(e,!0)),t}async paginate(e){}}},function(e,t){e.exports=require("@schirrel/pg-connection/Repository")},function(e,t){e.exports=require("@schirrel/pg-connection/Model")},function(e,t,r){const s=r(5);e.exports=class extends s{constructor(e={}){super("USER"),this.addColumn("email","EMAIL"),this.addColumn("name","NAME"),this.addColumn("password","PASSWORD"),this.addColumn("birthday","BIRTHDAY"),this.addColumn("facebookId","FACEBOOK_ID"),this.setValues(e)}}},function(e,t,r){const s=r(1),a=r(2);e.exports=async(e,t,r)=>{try{const s=e.header("Authorization");if(s){const e=s.replace("Bearer","").trim();a.decode(e)}else t.status(401).send({error:"Please authenticate!"});r()}catch(e){s.error(e),t.status(401).send({error:"Please authenticate!"})}}},function(e,t,r){const s=r(3),a=r(9),n=r(23),o=r(6);e.exports=class extends s{constructor(){super(n,o),this.profileService=new a}validateUniqueEmail(){}validateCreate(e){if(!e.name)throw Error("Name is required");if(!e.email)throw Error("E-mail is required");if(!e.password)throw Error("Password is required")}async create(e){this.validateCreate(e);let t=await super.create(e);if(t){let e=await this.profileService.defaultCreate({name:"Meu Perfil",main:!0,user:t.id});t.profile=e}return t}}},function(e,t,r){const s=r(3),a=r(21),n=r(2),o=r(10);e.exports=class extends s{constructor(){super(a,o)}validateUniqueEmail(){}validateCreate(e){if(!e.name)throw Error("Name is required");if(!e.user)throw Error("User is required");"undefined"!=e.main&&null!=e.main||(e.main=!1)}async create(e){let t=e.body,r=n.decode(n.getToken(e));return r.data&&(t.user=r.data),await this.defaultCreate(t)}async defaultCreate(e){return this.validateCreate(e),await super.create(e)}async search(e,t={}){let r=t,s=n.decode(n.getToken(e));if(s&&s.data)return r.user=s.data,await super.search(r);throw new Error("User required")}async main(e){let t=n.decode(n.getToken(e));(await super.search({user:t.data,main:!0})).forEach(async e=>{e.main=!1,await super.update(e)});let r=await this.get(parseInt(e.params.id));r.main=!0;let s=await super.update(r);if(s.main)return s;throw new Error("Ocorreu um erro ao atualizar perfil principal")}}},function(e,t,r){const s=r(5);e.exports=class extends s{constructor(e={}){super("PROFILE"),this.addColumn("name","NAME"),this.addColumn("main","MAIN"),this.addColumn("user","USER_ID"),this.setValues(e)}}},function(e,t){e.exports=require("dotenv")},function(e,t,r){const s=r(3),a=r(26),n=r(13),o=r(14),i=r(2);e.exports=class extends s{constructor(){super(a,n)}validateCreate(e){if(!e.movie)throw Error("Movie is required");if(!e.profile)throw Error("Profile is required");"undefined"!=e.watched&&null!=e.watched||(e.watched=!1)}async create(e){this.validateCreate(e);try{return await super.create(e)}catch(e){return e}}async getByMovie(e,t){let r=await super.search({movie:e,profile:t});return r.length?r[0]:null}async watched(e){let t=e.params.id,r=i.decode(i.getToken(e)),s=await this.getByMovie(t,r.data);if(s){s.watched=!0;let e=await super.update(s);if(e.watched)return e}}async populate(e){let t=await e.map(async e=>{let t=await o.movies.get(e.movie);return t.myData=e,t});return await Promise.all(t)}async myList(e){let t=await super.search({profile:e});return await this.populate(t)}}},function(e,t,r){const s=r(5);e.exports=class extends s{constructor(e={},t){super("MOVIE"),this.addColumn("movie","MOVIE_ID"),this.addColumn("watched","WATCHED"),this.addColumn("profile","PROFILE_ID"),this.addColumn("genres","GENRES"),this.setValues(e,t)}}},function(e,t,r){const s=r(27),a=s.create({baseURL:"https://api.themoviedb.org/3"});a.interceptors.request.use(e=>(e.params={api_key:"2402a694b08bf99a6cd32b20e3ce58fc",...e.params},e));const n={popular:async e=>(await a.get("movie/popular",{page:e})).data,get:async e=>(await a.get("movie/"+e)).data,byGenre:async e=>(await a.get("discover/movie",{params:{with_genres:e}})).data};e.exports={genres:async()=>(await a.get("genre/movie/list")).data.genres,movies:n}},function(e,t,r){const s=r(5);e.exports=class extends s{constructor(e={}){super("REMINDER"),this.addColumn("movie","MOVIE_ID"),this.addColumn("title","MOVIE_TITLE"),this.addColumn("reminderAt","REMINDER_AT"),this.addColumn("profile","PROFILE_ID"),this.addColumn("createdAt","CREATED_AT"),this.setValues(e)}}},function(e,t,r){r(17),e.exports=r(18)},function(e,t){e.exports=require("@babel/polyfill")},function(e,t,r){const s=r(19),a=r(0),n=a();var o=r(35);r(11).config();const i=r(1),c=r(36),u=process.env.PORT||3e3;n.use(o()),n.options("*",o()),n.use(c.urlencoded({extended:!0})),n.use(c.json()),n.use("/api",s),n.listen(u,()=>{i.info("App started at "+u)}),n.use(a.static(__dirname+"/public"))},function(e,t,r){const s=r(0).Router(),a=r(1);s.use("/user",r(20)),s.use("/profile",r(24)),s.use("/movie",r(25)),s.use(r(30)),s.use("/reminder",r(32)),a.info("Router setted"),e.exports=s},function(e,t,r){let s=r(0).Router();const a=r(8),n=r(1);this.service=new a,s.post("/",async(e,t)=>{let r=e.body;try{let e=await this.service.create(r);e.erro?t.status(500).send(e):t.send(e)}catch(e){n.error(e),t.status(500).send(e.message)}}),e.exports=s},function(e,t,r){const s=r(4),a=r(10);e.exports=class extends s{constructor(){super(a)}}},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,r){const s=r(4),a=r(6);e.exports=class extends s{constructor(){super(a)}}},function(e,t,r){let s=r(0).Router(),a=r(7);const n=r(9);this.service=new n,s.use(a),s.post("/",async(e,t)=>{try{let r=await this.service.create(e);r.erro?t.status(500).send(r):t.send(r)}catch(e){t.status(500).send(e.message)}}),s.get("/search",async(e,t)=>{let r=await this.service.search(e);t.send(r)}),s.put("/:id/main",async(e,t)=>{try{let r=await this.service.main(e);t.send(r)}catch(e){t.status(500).send(e)}}),s.put("/:id",async(e,t)=>{let r=e.params.id,s=e.body;try{let e=await this.service.update(s,r);e.erro?t.status(500).send(e):t.send(e)}catch(e){t.status(500).send(e)}}),e.exports=s},function(e,t,r){let s=r(0).Router(),a=r(7);const n=r(12),o=r(28);this.service=new n,s.use(a),s.post("/",async(e,t)=>{let r=e.body;try{let e=await this.service.create(r);e.erro?t.status(500).send(e.message):t.send(e)}catch(e){t.status(500).send(e.message)}}),s.get("/search",async(e,t)=>{let r=await this.service.search(e.query);t.send(r)}),s.get("/list/:id",async(e,t)=>{let r=e.params.id,s=await this.service.myList(r);t.send(s)}),s.put("/:id",async(e,t)=>{let r=e.params.id,s=e.body;try{let e=await this.service.update(s,r);e.erro?t.status(500).send(e):t.send(e)}catch(e){t.status(500).send(e)}}),s.put("/:id/watched",async(e,t)=>{try{let r=await this.service.watched(e);r.erro?t.status(500).send(r):t.send(r)}catch(e){t.status(500).send(e)}}),s.get("/suggestion/:id",async(e,t)=>{let r=e.params.id,s=await o(r);t.send(s)}),e.exports=s},function(e,t,r){const s=r(4),a=r(13);e.exports=class extends s{constructor(){super(a)}}},function(e,t){e.exports=require("axios")},function(e,t,r){const s=r(14),a=new(r(12)),n=r(29);e.exports=async e=>{let t=await a.search({profile:e}),r=(await(async e=>{let t=e.map(e=>{let t=e.genres;return t?(t=t.replace("{","["),t=t.replace("}","]"),Array.from(JSON.parse(t))):null});return t=n.flatten(t),t=t.sort(),[...new Set(t)]})(t)).filter(e=>e&&parseInt(e));return r=r.join(","),await(async e=>await s.movies.byGenre(e))(r)}},function(e,t){e.exports={flatten:function e(t){return 0==t.length?t:Array.isArray(t[0])?e(t[0]).concat(e(t.slice(1))):[t[0]].concat(e(t.slice(1)))}}},function(e,t,r){let s=r(0).Router();const a=r(31);s.post("/login",async(e,t)=>{let r=e.body;try{let e=await a.authUser(r);t.send(e)}catch(e){t.status(401).send(e.message)}}),e.exports=s},function(e,t,r){r(6);const s=r(2),a=new(r(8));e.exports=class{static async authUser(e){let t=await a.search({email:e.email});if(t&&t.length){let r=t[0];if(r.password===e.password){return await s.encode(r.id)}throw new Error("Credenciais inválidas")}throw new Error("Usuario não encontrado")}}},function(e,t,r){let s=r(0).Router(),a=r(7);const n=r(33);this.service=new n,s.use(a),s.post("/",async(e,t)=>{let r=e.body;try{let e=await this.service.create(r);e.erro?t.status(500).send(e.message):t.send(e)}catch(e){t.status(500).send(e.message)}}),s.get("/search",async(e,t)=>{let r=await this.service.search(e);t.send(r)}),e.exports=s},function(e,t,r){const s=r(3),a=r(34),n=r(15),o=r(2);e.exports=class extends s{constructor(){super(a,n)}async create(e){try{return await super.create(e)}catch(e){throw super.logger.log(e),{erro:!0,message:e}}}async search(e){let t=o.decode(o.getToken(e)).data;return await super.search({profile:t})}}},function(e,t,r){const s=r(4),a=r(15);e.exports=class extends s{constructor(){super(a)}}},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("body-parser")}]);